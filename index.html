<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MR Kamui Art Museum</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mr-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
        }

        #mr-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        #mr-button:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        #mr-button.hidden {
            display: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 5;
        }

        #loading.hidden {
            display: none;
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="loading">モデルを読み込み中...</div>
    <button id="mr-button" class="hidden">MRを起動</button>
    <div id="info">マウスドラッグで回転 • ホイールでズーム</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { XRButton } from 'three/addons/webxr/XRButton.js';

        let scene, camera, renderer, controls;
        let model;
        let xrSession = null;

        // シーンの初期化
        function init() {
            const container = document.getElementById('canvas-container');

            // シーン作成
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);

            // カメラ設定
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 2, 5);

            // レンダラー設定
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;

            // WebXR有効化
            renderer.xr.enabled = true;

            container.appendChild(renderer.domElement);

            // オービットコントロール
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);

            // ライティング設定
            setupLighting();

            // GLBモデル読み込み
            loadModel();

            // MRボタンの設定
            setupMRButton();

            // リサイズ対応
            window.addEventListener('resize', onWindowResize);
        }

        // ライティング設定
        function setupLighting() {
            // 環境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // ディレクショナルライト（太陽光）
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -10;
            directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.camera.top = 10;
            directionalLight.shadow.camera.bottom = -10;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // ポイントライト
            const pointLight1 = new THREE.PointLight(0xffd700, 0.5, 10);
            pointLight1.position.set(-3, 3, 3);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0x00bfff, 0.5, 10);
            pointLight2.position.set(3, 3, -3);
            scene.add(pointLight2);

            // スポットライト
            const spotLight = new THREE.SpotLight(0xffffff, 0.5);
            spotLight.position.set(0, 8, 0);
            spotLight.angle = Math.PI / 4;
            spotLight.penumbra = 0.3;
            spotLight.decay = 2;
            spotLight.distance = 30;
            spotLight.castShadow = true;
            scene.add(spotLight);
        }

        // モデル読み込み
        function loadModel() {
            const loader = new GLTFLoader();
            const loadingElement = document.getElementById('loading');
            const mrButton = document.getElementById('mr-button');

            loader.load(
                './AstroRoom.glb',
                function(gltf) {
                    model = gltf.scene;

                    // モデルの設定
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    // スケール調整
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 3 / maxDim;
                    model.scale.multiplyScalar(scale);

                    // 中心に配置
                    const center = box.getCenter(new THREE.Vector3());
                    model.position.sub(center.multiplyScalar(scale));

                    scene.add(model);

                    // UI更新
                    loadingElement.classList.add('hidden');
                    mrButton.classList.remove('hidden');
                },
                function(xhr) {
                    const percentComplete = (xhr.loaded / xhr.total) * 100;
                    loadingElement.textContent = `モデルを読み込み中... ${Math.round(percentComplete)}%`;
                },
                function(error) {
                    console.error('モデル読み込みエラー:', error);
                    loadingElement.textContent = 'モデルの読み込みに失敗しました';
                }
            );
        }

        // MRボタン設定
        function setupMRButton() {
            const mrButton = document.getElementById('mr-button');

            // WebXRサポートチェック
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        mrButton.addEventListener('click', onMRButtonClick);
                    } else {
                        // AR非対応の場合はVRをチェック
                        navigator.xr.isSessionSupported('immersive-vr').then((vrSupported) => {
                            if (vrSupported) {
                                mrButton.textContent = 'VRを起動';
                                mrButton.addEventListener('click', onVRButtonClick);
                            } else {
                                mrButton.textContent = 'XR非対応';
                                mrButton.disabled = true;
                            }
                        });
                    }
                });
            } else {
                mrButton.textContent = 'WebXR非対応';
                mrButton.disabled = true;
            }
        }

        // MRボタンクリック
        async function onMRButtonClick() {
            const mrButton = document.getElementById('mr-button');

            if (xrSession) {
                await xrSession.end();
                xrSession = null;
                mrButton.textContent = 'MRを起動';
                return;
            }

            try {
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test', 'dom-overlay'],
                    domOverlay: { root: document.body }
                });

                renderer.xr.setReferenceSpaceType('local');
                await renderer.xr.setSession(xrSession);

                // MR開始時にモデルをプレイヤーの目の前に配置
                if (model) {
                    model.position.set(0, -1, -3); // 前方3m、床に近い位置
                    model.rotation.y = 0; // 正面を向くように回転をリセット
                }

                mrButton.textContent = 'MRを終了';

                xrSession.addEventListener('end', () => {
                    xrSession = null;
                    mrButton.textContent = 'MRを起動';
                    // MR終了時に元の位置に戻す
                    if (model) {
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 3 / maxDim;
                        model.position.sub(center.multiplyScalar(scale));
                    }
                });

            } catch (error) {
                console.error('MRセッション開始エラー:', error);
                alert('MRモードの起動に失敗しました');
            }
        }

        // VRボタンクリック（フォールバック）
        async function onVRButtonClick() {
            const mrButton = document.getElementById('mr-button');

            if (xrSession) {
                await xrSession.end();
                xrSession = null;
                mrButton.textContent = 'VRを起動';
                return;
            }

            try {
                xrSession = await navigator.xr.requestSession('immersive-vr');

                renderer.xr.setReferenceSpaceType('local');
                await renderer.xr.setSession(xrSession);

                mrButton.textContent = 'VRを終了';

                xrSession.addEventListener('end', () => {
                    xrSession = null;
                    mrButton.textContent = 'VRを起動';
                });

            } catch (error) {
                console.error('VRセッション開始エラー:', error);
                alert('VRモードの起動に失敗しました');
            }
        }

        // ウィンドウリサイズ
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // アニメーションループ
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            // モデルを回転
            if (model && !xrSession) {
                model.rotation.y += 0.002;
            }

            if (controls && !xrSession) {
                controls.update();
            }

            renderer.render(scene, camera);
        }

        // 初期化と開始
        init();
        animate();
    </script>
</body>
</html>